# TASK-006: 신고/분쟁 시스템 (모바일)

**작성일**: 2026-02-11
**작성자**: PM
**담당 팀**: Mobile
**담당자**: Mobile Agent
**상태**: ⏳ 대기
**우선순위**: 🔴 High

---

## 📋 작업 개요

### 작업 설명
거래 분쟁 신고 기능의 모바일 클라이언트를 구현하라. 신고 생성 플로우, 증거 이미지 업로드, 신고 목록/상세 화면을 제공하라.

### 목표
- 채팅방/거래 상세/티켓 상세에서 신고 진입 가능
- 신고 생성 플로우: 사유 선택 → 설명 입력 → 증거 이미지 업로드
- 신고 목록/상세 화면 구현
- 신고 상태 타임라인 표시

### 배경
티켓 거래 과정에서 발생하는 분쟁(가짜 티켓, 미배송 등)을 사용자가 직접 신고할 수 있어야 한다. Backend TASK-006에서 신고 API를 제공하며, 모바일에서는 사용자 인터페이스를 담당한다.

### ⚠️ 플랫폼 전략: Android-First
Apple 유료 개발자 계정 미확보 상태 (1-2개월 내 확보 예정). Flutter 코드는 양 플랫폼 공유이므로 코드 작성에는 영향 없음. **모든 테스트는 Android에서 진행**하고, iOS는 계정 확보 후 일괄 검증한다.

---

## 🎯 완료 기준 (Acceptance Criteria)

- [ ] 채팅방 메뉴에서 "신고하기" 진입 가능
- [ ] 거래 상세 화면에서 "신고하기" 진입 가능
- [ ] 신고 생성 플로우 완성 (사유 선택 → 설명 입력 → 증거 첨부 → 제출)
- [ ] 신고 목록 화면 구현 (프로필/설정에서 접근)
- [ ] 신고 상세 화면 구현 (상태 타임라인, 증거, 거래 정보)
- [ ] 증거 이미지 업로드 동작 (최대 5건)
- [ ] 신고 취소 기능 동작 (PENDING 상태에서만)
- [ ] 에러 처리 (중복 신고, 권한 오류 등) 사용자 친화적 메시지 표시

---

## 🔧 기술 스펙 (Mobile)

### 신고 진입점

| 진입 위치 | 접근 방법 | 전달 데이터 |
|-----------|-----------|-------------|
| 채팅방 | 우상단 메뉴 → "신고하기" | transactionId (채팅방의 거래 ID) |
| 거래 상세 | 하단 액션 → "신고하기" | transactionId |
| 티켓 상세 | 판매자 정보 → "신고하기" | 해당 거래의 transactionId |

### 신고 유형

| Code | 표시 텍스트 | 아이콘 |
|------|------------|--------|
| `FAKE_TICKET` | 가짜/위조 티켓 | 🚫 |
| `WRONG_TICKET` | 잘못된 티켓 (좌석/날짜 불일치) | ❌ |
| `NO_DELIVERY` | 티켓 미배송 | 📦 |
| `RUDE_BEHAVIOR` | 비매너 행위 | 😤 |
| `OTHER` | 기타 | ❓ |

### 신고 상태

| Code | 표시 텍스트 | 색상 |
|------|------------|------|
| `PENDING` | 접수 대기 | 주황색 |
| `IN_REVIEW` | 검토 중 | 파란색 |
| `RESOLVED_BUYER` | 구매자 승 (환불 완료) | 초록색 |
| `RESOLVED_SELLER` | 판매자 승 | 회색 |
| `REJECTED` | 신고 기각 | 빨간색 |
| `CANCELLED` | 취소됨 | 회색 |

### API 연동

| 엔드포인트 | 용도 |
|------------|------|
| `POST /api/disputes` | 신고 생성 |
| `GET /api/disputes` | 내 신고 목록 |
| `GET /api/disputes/{id}` | 신고 상세 |
| `POST /api/disputes/{id}/evidence` | 증거 이미지 첨부 |
| `PUT /api/disputes/{id}/cancel` | 신고 취소 |

---

## 📱 화면 구조

### 신고 생성 플로우 (3단계)

#### Step 1: 사유 선택
```
┌──────────────────────────┐
│  ← 신고하기         1/3   │
├──────────────────────────┤
│                          │
│  신고 사유를 선택하라      │
│                          │
│  ┌──────────────────────┐│
│  │ 🚫 가짜/위조 티켓      ││  ← 선택 가능
│  └──────────────────────┘│
│  ┌──────────────────────┐│
│  │ ❌ 잘못된 티켓         ││
│  └──────────────────────┘│
│  ┌──────────────────────┐│
│  │ 📦 티켓 미배송         ││
│  └──────────────────────┘│
│  ┌──────────────────────┐│
│  │ 😤 비매너 행위         ││
│  └──────────────────────┘│
│  ┌──────────────────────┐│
│  │ ❓ 기타               ││
│  └──────────────────────┘│
│                          │
│  ┌──────────────────────┐│
│  │       다음             ││  ← 사유 선택 후 활성화
│  └──────────────────────┘│
└──────────────────────────┘
```

#### Step 2: 설명 입력
```
┌──────────────────────────┐
│  ← 신고하기         2/3   │
├──────────────────────────┤
│                          │
│  상세 내용을 입력하라      │
│  (최소 10자)             │
│                          │
│  ┌──────────────────────┐│
│  │                      ││
│  │  (텍스트 입력 영역)    ││
│  │                      ││
│  │              42/500  ││
│  └──────────────────────┘│
│                          │
│  ┌──────────────────────┐│
│  │       다음             ││
│  └──────────────────────┘│
└──────────────────────────┘
```

#### Step 3: 증거 첨부 + 제출
```
┌──────────────────────────┐
│  ← 신고하기         3/3   │
├──────────────────────────┤
│                          │
│  증거 이미지 (선택, 최대 5)│
│                          │
│  ┌────┐ ┌────┐ ┌────┐   │
│  │ 📷 │ │img1│ │img2│   │
│  │추가 │ │  ✕ │ │  ✕ │   │
│  └────┘ └────┘ └────┘   │
│                          │
│  요약:                    │
│  사유: 가짜/위조 티켓      │
│  설명: QR코드가 유효하지...│
│  증거: 2건               │
│                          │
│  ┌──────────────────────┐│
│  │      신고 제출          ││
│  └──────────────────────┘│
└──────────────────────────┘
```

### 신고 목록 화면
```
┌──────────────────────────┐
│  ← 내 신고 내역           │
├──────────────────────────┤
│ ┌──────────────────────┐ │
│ │ 🚫 가짜/위조 티켓      │ │
│ │ 거래 #10 | 아이유 콘서트│ │
│ │ 🟠 접수 대기    2/11   │ │
│ └──────────────────────┘ │
│ ┌──────────────────────┐ │
│ │ 📦 티켓 미배송         │ │
│ │ 거래 #8 | BTS 팬미팅   │ │
│ │ 🟢 환불 완료    2/05   │ │
│ └──────────────────────┘ │
│                          │
│     신고 내역이 없습니다    │  ← 빈 상태 (신고 0건일 때)
│                          │
├──────────────────────────┤
│  🏠   🔍   💬   👤      │
└──────────────────────────┘
```

### 신고 상세 화면
```
┌──────────────────────────┐
│  ← 신고 상세              │
├──────────────────────────┤
│                          │
│  🚫 가짜/위조 티켓        │
│  🟠 접수 대기             │
│                          │
│  ─── 거래 정보 ───       │
│  아이유 콘서트 S석         │
│  150,000원               │
│  구매자: 나 / 판매자: 홍길동│
│                          │
│  ─── 신고 내용 ───       │
│  QR코드가 유효하지 않습니다│
│                          │
│  ─── 증거 이미지 ───     │
│  ┌────┐ ┌────┐          │
│  │img1│ │img2│          │
│  └────┘ └────┘          │
│  [+ 증거 추가]            │  ← PENDING/IN_REVIEW일 때만
│                          │
│  ─── 진행 상황 ───       │
│  ● 2/11 10:00 신고 접수   │
│  ○ 검토 중                │  ← 타임라인
│  ○ 처리 완료              │
│                          │
│  ┌──────────────────────┐│
│  │     신고 취소           ││  ← PENDING일 때만 표시
│  └──────────────────────┘│
└──────────────────────────┘
```

---

## 📂 파일 구조

### Mobile
```
lib/features/dispute/
├── data/
│   ├── datasources/
│   │   └── dispute_remote_datasource.dart    — API 호출
│   ├── dto/
│   │   ├── create_dispute_req_dto.dart       — 신고 생성 요청
│   │   ├── dispute_list_resp_dto.dart        — 신고 목록 응답
│   │   └── dispute_detail_resp_dto.dart      — 신고 상세 응답
│   └── repositories/
│       └── dispute_repository_impl.dart      — Repository 구현
├── domain/
│   ├── entities/
│   │   ├── dispute_entity.dart               — 신고 엔티티
│   │   └── dispute_evidence_entity.dart      — 증거 엔티티
│   ├── repositories/
│   │   └── dispute_repository.dart           — Repository 인터페이스
│   └── usecases/
│       ├── create_dispute_usecase.dart       — 신고 생성
│       ├── get_disputes_usecase.dart         — 신고 목록 조회
│       ├── get_dispute_detail_usecase.dart   — 신고 상세 조회
│       ├── add_evidence_usecase.dart         — 증거 첨부
│       └── cancel_dispute_usecase.dart       — 신고 취소
└── presentation/
    ├── viewmodels/
    │   ├── create_dispute_viewmodel.dart     — 신고 생성 상태 관리
    │   ├── dispute_list_viewmodel.dart       — 신고 목록 상태 관리
    │   └── dispute_detail_viewmodel.dart     — 신고 상세 상태 관리
    ├── views/
    │   ├── create_dispute_view.dart          — 신고 생성 (3단계 플로우)
    │   ├── dispute_list_view.dart            — 신고 목록
    │   └── dispute_detail_view.dart          — 신고 상세
    └── widgets/
        ├── dispute_type_selector.dart        — 사유 선택 위젯
        ├── evidence_image_picker.dart        — 증거 이미지 선택/미리보기
        ├── dispute_status_badge.dart         — 상태 뱃지
        ├── dispute_timeline.dart             — 상태 타임라인
        └── dispute_item_widget.dart          — 목록 항목
```

### 수정 필요
```
lib/features/chat/presentation/views/    — 채팅방 메뉴에 "신고하기" 추가
lib/features/transaction/presentation/   — 거래 상세에 "신고하기" 추가
lib/core/navigation/                     — 신고 관련 라우트 추가
lib/features/profile/presentation/       — 프로필/설정에 "내 신고 내역" 메뉴 추가
```

---

## ✅ 작업 체크리스트

### 개발
- [ ] 신고 생성 플로우 (3단계) 구현
- [ ] 신고 목록 화면 구현
- [ ] 신고 상세 화면 구현 (타임라인, 증거, 거래 정보)
- [ ] 증거 이미지 선택/업로드 구현
- [ ] 신고 취소 기능 구현
- [ ] 기존 화면에 신고 진입점 추가 (채팅방, 거래 상세)
- [ ] 프로필/설정에 "내 신고 내역" 메뉴 추가
- [ ] Clean Architecture 구조 준수

### 테스트 (Android)
- [ ] 신고 생성 플로우 테스트
- [ ] 증거 이미지 업로드 테스트
- [ ] 신고 목록/상세 테스트
- [ ] 신고 취소 테스트
- [ ] 에러 케이스 테스트
- [ ] Android 수동 테스트 완료
- [ ] ⏸️ iOS 테스트 — Apple Developer 계정 확보 후 일괄 검증

### 코드 품질
- [ ] 린팅 에러 없음
- [ ] 코딩 컨벤션 준수
- [ ] 자체 코드 리뷰 완료

---

## 🧪 테스트 시나리오

### 시나리오 1: 신고 생성 정상 플로우
```
동작:
1. 거래 상세 화면에서 "신고하기" 탭
2. 사유 선택: "가짜/위조 티켓"
3. 설명 입력: "QR코드가 유효하지 않습니다. 입장 시 스캔이 되지 않았습니다."
4. 증거 이미지 2장 선택
5. "신고 제출" 탭

예상 결과:
- 로딩 표시
- 신고 생성 성공
- 증거 이미지 업로드 완료
- 성공 토스트: "신고가 접수되었습니다"
- 신고 상세 화면으로 이동
```

### 시나리오 2: 중복 신고 에러 처리
```
전제: 해당 거래에 이미 활성 신고 존재

동작:
1. 신고 생성 시도
2. API 응답: 409 Conflict

예상 결과:
- 에러 다이얼로그: "해당 거래에 이미 처리 중인 신고가 있습니다"
- 신고 생성 화면 유지
```

### 시나리오 3: 설명 글자 수 미달
```
동작:
1. 사유 선택 후 설명 입력: "가짜" (4자)
2. "다음" 버튼 탭

예상 결과:
- "다음" 버튼 비활성 상태
- 안내 텍스트: "최소 10자 이상 입력하라" 표시
```

### 시나리오 4: 증거 이미지 5건 초과 시도
```
전제: 이미 증거 이미지 5건 선택됨

동작:
1. "이미지 추가" 버튼 탭

예상 결과:
- 토스트: "증거 이미지는 최대 5장까지 첨부할 수 있습니다"
- 이미지 선택기 열리지 않음
```

### 시나리오 5: 신고 취소
```
전제: PENDING 상태 신고 존재

동작:
1. 신고 상세 화면에서 "신고 취소" 탭
2. 확인 다이얼로그에서 "취소하기" 탭

예상 결과:
- PUT /api/disputes/{id}/cancel 호출
- 성공 토스트: "신고가 취소되었습니다"
- 상태가 CANCELLED로 변경
- "신고 취소" 버튼 사라짐
```

### 시나리오 6: 신고 상세 + 증거 추가
```
전제: PENDING 상태 신고 존재, 증거 1건

동작:
1. 신고 상세 화면 진입
2. "증거 추가" 탭
3. 이미지 1장 선택 + 메모 입력
4. 업로드 완료

예상 결과:
- POST /api/disputes/{id}/evidence 호출
- 증거 목록에 새 이미지 추가 표시
- 성공 토스트: "증거가 첨부되었습니다"
```

---

## 🔗 의존성

### 선행 작업
- [ ] Backend TASK-006: 신고 시스템 API 구현 완료

### 필요한 패키지
- `image_picker` (이미 설치되어 있을 수 있음 — 기존 FileUpload 기능)

### 후속 작업
- [ ] TASK-005 연동: 신고 알림 수신 시 딥링크로 신고 상세 이동
- [ ] 관리자 앱: 신고 검토/해결 UI (Phase 3)

---

## ⏱️ 예상 소요 시간

| 단계 | 시간 |
|------|------|
| DTO/Repository/UseCase 생성 | 2시간 |
| 신고 생성 플로우 (3단계 UI) | 4시간 |
| 신고 목록 화면 | 2시간 |
| 신고 상세 화면 (타임라인, 증거) | 3시간 |
| 증거 이미지 업로드 연동 | 2시간 |
| 기존 화면 수정 (진입점 추가) | 1시간 |
| 테스트 | 2시간 |
| 버그 수정 | 1시간 |
| **총 예상 시간** | **17시간 (약 2.5일)** |

---

## 📅 일정

- **시작일**: 2026-02-12
- **목표 완료일**: 2026-02-15
- **실제 완료일**: -

---

## 🚨 리스크 및 고려사항

### 기술적 리스크
- **이미지 업로드 용량**: 대용량 이미지(10MB) 업로드 시 시간 소요 → 업로드 진행률 표시, 압축 적용 검토
- **3단계 플로우 상태 관리**: 뒤로 가기 시 이전 입력 유지 → ViewModel에서 상태 관리

### 블로커
- Backend TASK-006 API 완료 전까지 Mock 데이터로 UI 선행 개발 가능

---

## ⚠️ 주의사항

### UX
- 신고 제출은 되돌릴 수 없으므로 제출 전 확인 다이얼로그 표시
- 증거 이미지는 선택 즉시 업로드하지 않고, 최종 제출 시 일괄 업로드
- 신고 취소도 확인 다이얼로그 표시

### Clean Architecture
- Data → Domain → Presentation 의존성 방향 엄수
- ViewModel은 UseCase만 호출
- 이미지 선택은 Presentation 레이어, 업로드는 Data 레이어

### 에러 처리
- 네트워크 오류: 재시도 안내
- 409 Conflict (중복 신고): 명확한 안내 메시지
- 403 Forbidden (권한 없음): "구매자만 신고할 수 있습니다"
- 이미지 업로드 실패: 개별 실패 항목 표시, 재시도 가능

---

## 📚 참고 자료

- Backend TASK-006: `docs/backend/tasks/TASK-006_Dispute_System.md`
- 기존 SellTicket 플로우 — 다단계 폼 패턴 참고
- 기존 FileUploadService — 이미지 업로드 패턴 참고

---

**리뷰어**: Mobile Lead
**리뷰 완료일**: -
**상태**: ⏳ 대기
